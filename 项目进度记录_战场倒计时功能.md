# 项目进度记录 - 战场倒计时功能

## 📅 记录时间
**2024年12月27日**

## ✅ 当前已实现功能

### 1. 双向通信功能
- ✅ WebSocket 连接已建立（客户端 ↔ 服务端）
- ✅ 客户端可以发送宣战请求到服务端
- ✅ 服务端可以广播倒计时消息到客户端
- ✅ 连接错误处理和重连机制已实现

### 2. 实时倒计时功能
- ✅ 服务端每秒广播倒计时消息
- ✅ 客户端每秒接收并打印倒计时进度
- ✅ 控制台实时显示倒计时情况（服务端和客户端都有详细日志）

### 3. 数据隔离
- ✅ 每个国家的倒计时任务独立管理（使用 ConcurrentDictionary）
- ✅ A国家的倒计时不影响B国家

## 📁 关键文件列表

### 服务端文件
1. **`jiuzhou/战场管理.cs`** (450行)
   - 所有王城战逻辑都在此文件
   - `处理宣战请求()` - 处理宣战逻辑
   - `启动倒计时()` - 启动30秒倒计时
   - `广播倒计时()` - 每秒广播给对应家族玩家

2. **`jiuzhou/服务端代码_Program.cs`** (5470行)
   - `/api/declareWar` 端点（第1328行）- 只调用战场管理，不做逻辑处理
   - WebSocket `/ws` 端点（第191行）
   - 类型定义（第4612-4615行）：`DeclareWarRequest`, `DeclareWarResponse`

### 客户端文件
1. **`jiuzhou/Assets/Scripts/国家信息显示.cs`** (342行)
   - `点击宣战按钮()` - 处理宣战按钮点击
   - `发送宣战请求()` - 发送宣战请求到服务端
   - `宣战响应` 类型定义（第342行）

2. **`jiuzhou/Assets/Scripts/SignalR连接管理.cs`** (1343行)
   - WebSocket 连接管理
   - `处理战场倒计时事件()` - 处理服务端推送的倒计时消息（第893行）
   - `BattlefieldCountdownEvent` 类型定义（第1184行）
   - 连接地址：`ws://43.139.181.191:5000/ws`（第22行）

## 🔑 关键代码片段

### 服务端 - 倒计时广播逻辑
**文件：`战场管理.cs` 第276-284行**
```csharp
日志记录器.LogInformation($"[战场管理] ========== 倒计时广播 ========== 国家ID: {国家ID}, 剩余秒数: {剩余秒数}秒, 家族1: {家族1名称}({家族1ID}) VS 家族2: {家族2名称}({家族2ID})");

// 广播倒计时给两个家族的所有在线成员
await 广播倒计时(国家ID, 家族1ID, 家族1名称, 家族2ID, 家族2名称, 剩余秒数, 数据库连接字符串, 玩家连接映射, 日志记录器);

日志记录器.LogInformation($"[战场管理] 广播完成，等待1秒后继续");

// 等待1秒
await Task.Delay(1000, 取消令牌源.Token);
```

### 客户端 - 接收倒计时消息
**文件：`SignalR连接管理.cs` 第540-545行**
```csharp
case "BattlefieldCountdown":
    var countdownEvent = JsonUtility.FromJson<BattlefieldCountdownEvent>(message);
    Debug.Log($"[WebSocket] ========== 收到原始倒计时消息 ==========");
    Debug.Log($"[WebSocket] 原始消息内容: {message}");
    Debug.Log($"[WebSocket] 解析后 - 国家ID: {countdownEvent?.countryId}, 剩余秒数: {countdownEvent?.remainingSeconds}");
    处理战场倒计时事件(countdownEvent);
    处理成功 = true;
    break;
```

### 客户端 - 处理倒计时事件
**文件：`SignalR连接管理.cs` 第933-962行**
```csharp
// 在控制台每秒输出倒计时进度（重要：用于查看通信是否正常）
Debug.Log($"[战场倒计时] ========== 收到服务端倒计时广播 ==========");
Debug.Log($"[战场倒计时] 国家ID: {evt.countryId}, 剩余秒数: {evt.remainingSeconds}秒");
Debug.Log($"[战场倒计时] 家族1: {evt.clan1Name}({evt.clan1Id}) VS 家族2: {evt.clan2Name}({evt.clan2Id})");
Debug.Log($"[战场倒计时] 当前玩家ID: {当前玩家.ID}, 玩家家族ID: {当前玩家.家族.家族ID}");
Debug.Log($"[战场倒计时] ==========================================");
```

## 📊 数据流程

### 宣战流程
1. 客户端点击宣战按钮 → `国家信息显示.cs` → `发送宣战请求()`
2. HTTP POST `/api/declareWar` → `Program.cs` → `战场管理.处理宣战请求()`
3. 如果两个家族都宣战 → `战场管理.启动倒计时()`

### 倒计时广播流程
1. 服务端每秒执行：`战场管理.启动倒计时()` → `战场管理.广播倒计时()`
2. 查询两个家族的所有玩家ID
3. 通过 WebSocket 发送 `BattlefieldCountdown` 事件
4. 客户端接收：`SignalR连接管理.cs` → `处理战场倒计时事件()`
5. 控制台输出倒计时信息

## 🔧 配置信息

### WebSocket 连接地址
- **客户端配置**：`jiuzhou/Assets/Scripts/SignalR连接管理.cs` 第22行
  - 远程：`ws://43.139.181.191:5000/ws`
  - 本地：`ws://localhost:5000/ws`（注释中）

### 数据库配置
- **服务端**：`jiuzhou/服务端代码_Program.cs` 第44行
  - 连接字符串：`Server=localhost;Database=jiuzhou;User=root;Password=!Cao1054675525;Charset=utf8mb4;`

### API 端点
- **宣战接口**：`POST /api/declareWar`
- **WebSocket端点**：`/ws`

## 📝 日志输出示例

### 服务端日志
```
[战场管理] ========== 倒计时广播 ========== 国家ID: 5, 剩余秒数: 25秒, 家族1: 唯吾独尊(19) VS 家族2: 万国觉醒(20)
[战场管理] ========== 广播统计 ========== 国家ID: 5, 剩余秒数: 25秒
[战场管理] 查询到玩家总数: 6, 在线连接数: 2
[战场管理] 发送结果: 成功 2 个, 失败 0 个, 未找到连接 4 个, 连接已关闭 0 个
[战场管理] ✓ 成功向 2 个玩家发送了倒计时消息
```

### 客户端日志
```
[WebSocket] ========== 收到原始倒计时消息 ==========
[WebSocket] 原始消息内容: {"eventType":"BattlefieldCountdown","countryId":5,"clan1Id":19,"clan1Name":"唯吾独尊","clan2Id":20,"clan2Name":"万国觉醒","remainingSeconds":25}
[WebSocket] 解析后 - 国家ID: 5, 剩余秒数: 25
[战场倒计时] ========== 收到服务端倒计时广播 ==========
[战场倒计时] 国家ID: 5, 剩余秒数: 25秒
[战场倒计时] 家族1: 唯吾独尊(19) VS 家族2: 万国觉醒(20)
[战场倒计时] 当前玩家ID: 9, 玩家家族ID: 19
[战场倒计时] ==========================================
[战场倒计时] ✓ 倒计时已更新: 剩余 25 秒
```

## ⚠️ 重要注意事项

### 1. 代码组织原则
- **所有王城战逻辑必须在 `战场管理.cs` 中**
- **`Program.cs` 只负责调用，不做任何逻辑处理**
- **客户端只接收信息，不做本地倒计时逻辑处理**

### 2. 数据隔离
- 使用 `ConcurrentDictionary<int, CancellationTokenSource> 国家倒计时任务` 管理每个国家的倒计时
- 确保 A 国家的倒计时不影响 B 国家

### 3. 通信方式
- 使用 WebSocket 进行实时通信
- 服务端每秒广播一次倒计时
- 客户端每秒接收并显示

## 🧪 测试状态

### ✅ 已验证功能
- [x] 客户端可以发送宣战请求
- [x] 服务端可以接收宣战请求并处理
- [x] 两个家族都宣战后，服务端启动倒计时
- [x] 服务端每秒广播倒计时消息
- [x] 客户端可以接收倒计时消息
- [x] 控制台可以实时显示倒计时进度
- [x] 数据隔离正常（每个国家独立）

### ⚠️ 已知问题
- WebSocket 连接可能失败（已添加详细错误处理和日志）
- 如果连接失败，检查服务端是否运行、地址是否正确

## 🔄 恢复步骤

如果项目改废了，需要恢复到当前状态：

1. **恢复服务端文件**：
   - `jiuzhou/战场管理.cs` - 所有王城战逻辑
   - `jiuzhou/服务端代码_Program.cs` - API端点和类型定义

2. **恢复客户端文件**：
   - `jiuzhou/Assets/Scripts/国家信息显示.cs` - 宣战功能
   - `jiuzhou/Assets/Scripts/SignalR连接管理.cs` - WebSocket连接和倒计时处理

3. **检查配置**：
   - WebSocket 连接地址
   - 数据库连接字符串
   - API 端点路径

4. **验证功能**：
   - 启动服务端，检查日志
   - 启动客户端，检查连接
   - 两个家族宣战，观察倒计时日志

## 📌 关键原则

1. **服务端负责所有逻辑**：倒计时、广播、状态管理
2. **客户端只负责接收和显示**：不做任何本地倒计时逻辑
3. **数据隔离**：每个国家的倒计时任务独立
4. **实时通信**：使用 WebSocket 每秒广播
5. **详细日志**：服务端和客户端都有完整的日志输出

---

**⚠️ 警告：后续修改代码时，请确保不破坏以上功能！**

