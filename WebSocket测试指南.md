# WebSocket 实时通信测试指南

## 📋 测试前准备

### 1. 服务器端
- ✅ 确保服务器运行在 `http://43.139.181.191:5000`
- ✅ 检查服务器控制台，应该能看到 WebSocket 相关日志

### 2. Unity 客户端
- ✅ 确保场景中有 `SignalR连接管理` 组件（挂载在某个 GameObject 上）
- ✅ 确保该 GameObject 设置为 `DontDestroyOnLoad`（已在脚本中自动设置）

## 🧪 测试步骤

### 测试 1：验证 WebSocket 连接建立

1. **启动 Unity 客户端**
2. **登录账号**
3. **查看 Unity Console**，应该能看到：
   ```
   WebSocket 连接成功
   ```
4. **查看服务器控制台**，应该能看到：
   ```
   [WebSocket] 客户端已连接
   ```

✅ **如果看到以上日志，说明连接成功！**

---

### 测试 2：测试"踢出家族成员"实时通知

**准备：**
- 账号 A：族长或副族长，已登录并连接 WebSocket
- 账号 B：家族成员，已登录并连接 WebSocket

**操作步骤：**

1. **用账号 A 登录**，打开家族成员列表
2. **用账号 B 登录**（另一个 Unity 实例或设备）
3. **在账号 A 的客户端**：点击"踢出家族"按钮，踢出账号 B
4. **观察结果：**

   **账号 A（操作者）应该：**
   - Unity Console 显示：`收到游戏事件: ClanMemberKicked`
   - 提示框显示：`XXX已被XXX踢出家族`
   - 家族成员列表自动刷新

   **账号 B（被踢者）应该：**
   - Unity Console 显示：`收到游戏事件: ClanMemberKicked`
   - 提示框显示：`你已被XXX踢出家族`
   - 家族信息界面自动刷新为"无家族"状态

✅ **如果两个客户端都收到通知，说明实时通信成功！**

---

### 测试 3：测试"任命职位"实时通知

**准备：**
- 账号 A：族长，已登录
- 账号 B：家族成员，已登录

**操作步骤：**

1. **在账号 A 的客户端**：打开家族成员列表 → 点击某个成员 → 点击"家族任命" → 选择职位 → 点击"任命"
2. **观察结果：**

   **账号 A（操作者）应该：**
   - 家族成员列表自动刷新，显示新的职位信息

   **账号 B（被任命者）应该：**
   - Unity Console 显示：`收到游戏事件: ClanRoleAppointed`
   - 提示框显示：`你已被XXX任命为副族长`（或精英）
   - 家族信息界面自动刷新，显示新职位

✅ **如果被任命者收到通知，说明实时通信成功！**

---

### 测试 4：测试"解散家族"实时通知

**准备：**
- 账号 A：族长，已登录
- 账号 B：家族成员，已登录

**操作步骤：**

1. **在账号 A 的客户端**：打开家族信息界面 → 点击"解散家族"
2. **观察结果：**

   **账号 A（操作者）应该：**
   - 家族信息界面自动刷新为"无家族"状态

   **账号 B（成员）应该：**
   - Unity Console 显示：`收到游戏事件: ClanDisbanded`
   - 提示框显示：`家族XXX已被XXX解散`
   - 家族信息界面自动刷新为"无家族"状态

✅ **如果所有成员都收到通知，说明实时通信成功！**

---

### 测试 5：测试"加入家族"实时通知

**准备：**
- 账号 A：家族成员，已登录
- 账号 B：无家族玩家，已登录

**操作步骤：**

1. **账号 B 加入某个家族**（通过家族列表界面）
2. **观察结果：**

   **账号 A（家族成员）应该：**
   - Unity Console 显示：`收到游戏事件: ClanMemberJoined`
   - 如果正在查看家族成员列表，列表会自动刷新

✅ **如果现有成员收到通知，说明实时通信成功！**

---

### 测试 6：测试"退出家族"实时通知

**准备：**
- 账号 A：家族成员（非族长），已登录
- 账号 B：家族成员，已登录

**操作步骤：**

1. **在账号 A 的客户端**：打开家族信息界面 → 点击"退出家族"
2. **观察结果：**

   **账号 A（退出者）应该：**
   - 家族信息界面自动刷新为"无家族"状态

   **账号 B（其他成员）应该：**
   - Unity Console 显示：`收到游戏事件: ClanMemberLeft`
   - 如果正在查看家族成员列表，列表会自动刷新

✅ **如果其他成员收到通知，说明实时通信成功！**

---

### 测试 7：测试"家族捐献"实时通知

**准备：**
- 账号 A：家族成员，已登录，有足够铜钱（10000）
- 账号 B：家族成员，已登录

**操作步骤：**

1. **在账号 A 的客户端**：打开家族信息界面 → 点击"捐献"
2. **观察结果：**

   **账号 A（捐献者）应该：**
   - 提示框显示：`捐献成功！家族资金+100，繁荣值+10`

   **账号 B（其他成员）应该：**
   - Unity Console 显示：`收到游戏事件: ClanDonated`
   - 如果正在查看家族信息界面，界面会自动刷新，显示最新的资金和繁荣值

✅ **如果其他成员收到通知并看到数据更新，说明实时通信成功！**

---

## 🔍 调试技巧

### 查看 Unity Console 日志

所有 WebSocket 相关日志都会输出到 Unity Console：
- `WebSocket 连接成功` - 连接建立
- `收到游戏事件: XXX` - 收到服务器事件
- `处理 WebSocket 消息失败` - 消息解析错误

### 查看服务器控制台日志

服务器端会输出：
- `[WebSocket] 客户端已连接` - 新客户端连接
- `[WebSocket] 客户端已断开并移除` - 客户端断开
- `[WebSocket] 发送消息失败，移除连接` - 发送失败（连接可能已断开）

### 常见问题排查

1. **连接失败**
   - 检查服务器是否运行
   - 检查网络连接
   - 检查防火墙设置

2. **收不到事件通知**
   - 确认两个客户端都已连接 WebSocket
   - 检查 Unity Console 是否有错误日志
   - 检查服务器控制台是否有发送日志

3. **事件处理错误**
   - 检查 Unity Console 的错误日志
   - 确认事件 JSON 格式是否正确

---

## ✅ 测试完成标准

所有测试通过的标准：
- ✅ WebSocket 连接成功建立
- ✅ 所有家族操作都能实时通知到相关客户端
- ✅ 客户端 UI 能正确刷新
- ✅ 没有错误日志

如果所有测试都通过，说明 WebSocket 实时通信功能已完全正常工作！🎉

